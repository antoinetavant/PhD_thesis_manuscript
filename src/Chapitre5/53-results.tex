% !TEX root=/home/tavant/these/manuscript/src/manuscript.tex

\section{Comparison of the \ac{DR} with the \ac{PIC} simulations}
  \label{sec-DR-results}
  
  
  \subsection{Distribution function impacts} \label{subsec-DRimpact}
    Before using the electron and ion distribution functions measured in the \ac{PIC} simulations, we compare the distribution relation for \ac{ECDI} and \ac{IAW} for different analytic distribution function.
    
    \paragraph{Ion acoustic wave\\}
    
    \Cref{fig-IAW_Maxw} shows the comparison with the relation dispersion \cref{eq-drIAWgene} for cold ions and drifting Maxwellian electrons of temperature $\Te=50\,\volt$ and drift velocity $u_e = \sn{2}{6} \,\meter\per\second$ for which the plasma dispersion function $Z_M$ is computed analytically (with the \texttt{plasmapy} package) or numerically.
    The plasma density is $n_e = n_i = \sn{1}{17} \,\per\meter\cubed$.
    Is also shown the frequency and growth rate obtained the simplified dispersion relation of \cref{eq-MIAW}. 
    
    \begin{figure}[hbtp]
      \centering
      \includegraphics[width=\defaultwidth]{IAW_Maxw}
      \caption{\ac{IAW} frequency and growth rate for a Maxwellian distribution function using the Freid and Conte function (labelled Analytic $Z_M$), the numerical estimation of $\tilde{Z}_M$, and the simplified analytic expressions of \cref{eq-MIAW}. }
      \label{fig-IAW_Maxw}
    \end{figure}
    
    We can see that all results gives almost the same solutions.
    The growth rates are all overlapping, hence it is difficult to see the differences.
    For $\omega_r$, the simplified analytic expression returns a slightly different result, but the differences is negligible.
    The numerical evaluation of $\tilde{Z}_M$ give the same result as analytic evaluation.
    
    \Cref{fig-IAW_druv} shows the effect of a Druyvesteyn electron distribution compared to a Maxwellian.
    We recall that a Druyvesteyn distribution follows the expression
    \begin{equation} \label{eq-druyv}
      f_{D}(v) = \exp \lp C1 \frac{\norm{v}^3}{v_{th}^3}  \rp C2,
    \end{equation}
    with $C1 \simeq 0.63$ and $C2 \sim 0.84$ two normalizing constants.
    We can see that there is no much impact of the Druyvesteyn electron velocity distribution function on the electron, except that the maximum growth rate is sightly diminished.
    
    \begin{figure}[hbtp]
      \centering
      \includegraphics[width=\defaultwidth]{IAW_druv}
      \caption{\ac{IAW} frequency and growth rate for a Maxwellian distribution function using the Freid and Conte function and a Druyvesteyn distribution evaluated with the numerical estimation of $\tilde{Z}$. }
      \label{fig-IAW_druv}
    \end{figure}
    
    \paragraph{Electron Cyclotron Drift instability\\}
    
      \Cref{fig-ECDI_druv} shows the frequency and the grow rate for the \ac{ECDI}, using defined by \cref{eq-drECDI}, in the same conditions that the \ac{IAW} results, with $k_r \lambda_{De} = 0.1 $.
      The infinite sum over the cyclotron resonances is stopped at $N_{max} = 20$.
      
      
      \begin{figure}[hbtp]
      \centering
      \includegraphics[width=\defaultwidth]{ECDI_druv}
      \caption{\ac{ECDI} frequency and growth rate for a Maxwellian distribution function using the Freid and Conte function and a Druyvesteyn distribution evaluated with the numerical estimation of $\tilde{Z}$, the radial wave number is $k_r \lambda_{De} = 0.1 $.}
      \label{fig-ECDI_druv}
    \end{figure}
    
    We can see in \cref{fig-ECDI_druv} that the cyclotron resonances are present for both distribution functions.
    But while the growth rate is not much affected, the frequency is reduced for the Druyvesteyn distribution for larger azimuthal wave number.
    
    For a smaller radial wavenumber, the numerical resolution crashes, as the argument in the $Z$ function diverges.
    However, in the limit $\eta \rightarrow \infty, Z(\eta) \rightarrow  \frac{1}{\eta}$.
    Hence, still obtain the cyclotron resonances, as shown in \citet[Fig. 2]{janhunen2018}.

  \subsection{Distribution function measured} \label{subsec-VDFpic}
  
  Before solving the dispersion relation for the \ac{PIC} distribution function, we first observe the distribution functions.
  \Cref{fig-vdfs_pic_time} shows at different moments in the simulation the ion and electron azimuthal velocity distribution functions, normalized.
  The velocities are normalized by the thermal speed of the species.
  To guide the reading of the figure, is added the  theoretical electron drift velocity $u_e = \frac{E_z}{B_r}$, normalized to the electron thermal speed, as well as the ion sound speed $c_s$, normalized to the ion thermal velocity.
  The distributions are averages in time over $4\,\nano\second$, and in space over all the azimuthal direction.
  In the radial direction, the distributions are average over a small length at the center of the channel, between $r=0.45\,\centi\meter$ and $r=0.55\,\centi\meter$.
  
  \begin{figure}[hbtp]
    \centering
    \includegraphics[width=0.8\textwidth]{Distributions_time_evolution_2.pdf}
    \caption{Electron and ion normalized azimuthal velocity distribution functions. The velocity in abscissa is normalized by the thermal speed of the corresponding species. Is overlaid the theoretical $E\times B$ drift velocity of the electrons $u_e = \frac{E_z}{B_r}$, and the ion sound speed $c_s$ normalized by the ion thermal velocity.}
    \label{fig-vdfs_pic_time}
  \end{figure}
  
  We can observe in \cref{fig-vdfs_pic_time} that the electron mean velocity is always the $E \times B$ drift velocity, which is of the order of one quarter of the electron thermal speed.
  On the other hand, at the beginning of the simulation the mean velocity of the ion is null.
  But we can see that starting from $t=.8\,\micro\second$, the ions are dragged in the same direction that the electron drift.
  Here, we have to be careful not to misread the figure.
  As we have $v_{th, e} > v_{th, i}$, the effective drift velocity of the ion is much less that the electron.
  \inlinenote{Give the values here, like $ u_e, c_s, v_th$, etc.}
  \inlinenote{Maybe Do 2 figures ?  So that it is more readable ?}
  
  We can see that a small population of high energy ions is generated, because of particle-wave interactions.
  This leads to both an increases ion temperature, and the formation of a drift velocity in the azimuthal direction.
  The high energy ion population comes from ion trapping, as we can see that their velocity if of the order of the ion sound speed, which is close to the wave phase velocity \citep{lafleur2018}.
  
  \vspace{1em}
  As both electron and ion velocity distribution functions are far from a drifting Maxwellian, we will study the influence of both distributions in the calculations of the dispersion relation.
  
  
  
  \subsection{Resolution of the electron cyclotron drift instability} \label{subsec-ECDIPIC}
  
  
    As observed in \Cref{sec-PIC-ECDI}, the simulation begin by a linear growth of the instability.
    Previous results obtained with \LPPic \citep{croes2017a} showed no resonances during this period.
    However, these results where obtained with Lafleur's convection model, as introduced in \cref{sec-reinjectionnoise}.
    Here, the results where obtained with the modified model, inducing less noise.
    
    We can see in \Cref{fig-phi_fluctuation_summary}  a snapshot of the plasma potential fluctuation in the azimuthal direction \[ \delta \phi(r, \theta) = \phi(r, \theta) - < \phi(r, \theta) >_{ \theta}, \]
    at four different times during the growth of the instability.
    For this results, we increased the azimuthal length $L_{\theta}$ to $6\,\milli\meter$, so that the instability characteristics, as the wavenumber $k$, are more distinguishable.
    We observe no significant differences on the simulation results.
    However, the simulation time is doubled in this case, so only the first microseconds have been simulated.
    

    
    \begin{figure}[hbtp]
      \centering
      \includegraphics[width=6in]{phi_fluctuation_summary.pdf}
      \caption{Snapshot of the plasma potential at different times during the linear phase of the simulation.}
      \label{fig-phi_fluctuation_summary}
    \end{figure}
    
    At the beginning, we see fluctuations that can be due both thermal fluctuation \citep{salpeter1960} or numerical noise due to particle discretization.
    Then, the instability rises.
    We can see that it starts with small wavelength ($\lambda \simeq 0.75\,\milli\meter$ at $t=0.2\,\micro\second$).
    After a short period, the short wavelength waves merges to form longer wavelength waves  ($\lambda \simeq 1.5\,\milli\meter$ at $t=0.7\,\micro\second$).
    
    This is also clearly seen on the frequency spectra, showed in \Cref{fig-phi_fluctuation_summary_FFT}.
    We can see in the spectra the resonances at the cyclotron wavenumber $k_0 = \frac{\oce}{u_e} \simeq 3.5\,\milli\meter^{-1}$.
    
    \begin{figure}[hbtp]
      \centering
      \includegraphics[width=6in]{phi_fluctuation_summary_FFT.pdf}
      \caption{Frequency spectra on the azimuthal instability presented in \cref{fig-phi_fluctuation_summary}. The spectrum are average in the radial direction. The red dotted lines represent the cyclotron resonances.}
      \label{fig-phi_fluctuation_summary_FFT}
    \end{figure}
    
    At $t=0.2\,\micro\second$, the most dominant mode is the second resonance, but the other resonances start to appear.
    At $t=0.4\,\micro\second$, all of the resonances are distinguishable, but their amplitude is strictly decreasing.
    Then, at $t=0.7\,\micro\second$, we can no longer see the resonances, except for the first one.
    As we observed resonances in the Fourier spectrum, we solve the dispersion relation for the \ac{ECDI}.
    
    \vspace{1em}
    We solve the \ac{ECDI} dispersion relation of \cref{eq-drECDI} for $t=0.2, 0.4$ and $0.7\micro\second$ using both the Maxwellian hypothesis for the ions and electrons, and the velocity distribution functions measured in the \ac{PIC} simulations.
    The radial wavenumber taken is $k_r = 2 \pi/L_R \sim 0.6 \per\milli\meter$ \citep{lafleur2016,janhunen2018}.
    This value corresponds to $k_r \lde = 0.036$ at $t=0.2\,\micro\second$ and $k_r \lde = 0.044$ at $t=0.7\,\micro\second$, as the electron temperature increases.
    
    \begin{figure}[hbtp]
      \centering
      % \begin{tabular}{c}
        \includegraphics[width=0.45\textwidth]{ECDI_PIC_ionvcorrected_2mus.pdf} 
        \includegraphics[width=0.45\textwidth]{ECDI_PIC_ionvcorrected_4mus.pdf} 
        \includegraphics[width=0.45\textwidth]{ECDI_PIC_ionvcorrected_7mus.pdf} 
      % \end{tabular}
      \caption{Dispersion relation for the \ac{ECDI} using both (dotted lines) the Maxwellian hypothesis for the ions and electrons, and (solid lines) the velocity distribution functions measured in the \ac{PIC} simulations. The abscissa is normalized by the cyclotron resonance wavelength.}
      \label{fig-DRECDI}
    \end{figure}
    
    We can see in \Cref{fig-DRECDI} that the dispersion relation shows the cyclotron resonance at the beginning.
    However, the most rising wavelength is not the second harmonic, but the forth.
    After $t=4\,\micro\second$, the resonances broaden, and disappear.
    This is due to increases of the radial wavelength used with respect to the Debye length $\lde$ \citep{lafleur2016a,ducrocq2006,cavalier2013}.
    The value of radial wavelength is discuss later in \cref{sec-DR-BC}.
    
    We can also observe that the deviation of the distribution function from the Maxwellian decreases the growth rate.
    This as been observed  in an axial-azimuthal \ac{PIC} simulation by \citet{lafleur2018}.
    This confirm that the exact distribution function should be used in the calculation of the distribution function.
    
  \subsection{Resolution of the ion acoustic wave} \label{subsec-VDFIAW}
  
  We have see in the previous \cref{subsec-ECDIPIC} that the \ac{ECDI} dispersion relation is not needed, but can instead be approximated by the \ac{IAW} \citep{lafleur2018,janhunen2018,taccogna2019}.
  The \ac{IAW} relation can be solved with several hypotheses (see \cref{sec-geneDR} for more details)
  \begin{enumerate}
    \item Simplified analytical values,
    \item Maxwellian electrons, cold ion ($\Ti = 0\,\volt$),
    \item Maxwellian electrons and ions ($\Ti > 0\,\volt$),
    \item Non-Maxwellian electrons, Maxwellian ions ($\Ti > 0\,\volt$),
    \item Non-Maxwellian electrons and ions.
  \end{enumerate}
  
  We will use all of these cases, and compare them to the \ac{PIC} simulation results.
  We are willing to obtain the temporal evolution of the solution.
  In practice, we will only follow the evolution of the most growing wave.
  In order to find the most growing wave, we solve the dispersion relation for different values of $k$.
  Over all of the solutions obtained, we select the one corresponding to the maximum value of $\gamma$.
  We uses 100 values between $k=0.02 \lde$ and $k = 2 \lde$.
  \Cref{fig-Example_of_DR_IAW} illustrate the protocol used for 3 different cases.
  We can see the maximum of the growing rate, and its frequency.
  
  \begin{figure}[hbtp]
    \centering
    \includegraphics[width=4.5in]{Example_of_DR_IAW.pdf}
    \caption{Illustration of the \ac{IAW} dispersion relation obtained at two different time ($t=0$ and $t=1.2\,\micro\second$), using the hypothesis of Maxwellian distribution functions for both electrons and ions. The electron temperature measured in the simulation is always used, but the ion temperature is only used once. The most growing solution is marked with a circle on the growing rate and the frequency.}
    \label{fig-Example_of_DR_IAW}
  \end{figure}
  
  
  This calculation is automated for the whole duration of the simulation.
  The velocity distribution function, when used, are obtained from the \ac{PIC} simulation the same way that in \cref{subsec-VDFpic}.
  \Cref{fig-time_wave} shows the temporal evolution of the three characteristic of the most growing wave: the growth rate $\gamma$, the azimuthal wavenumber $k$ and the frequency $\omega$.
  \begin{figure}[hbtp]
    \centering
    % \includegraphics[width=\textwidth]{GrowthRate_time_evolution_250_ter.pdf}
    \includegraphics[width=\textwidth]{GrowthRate_time_evolution_250_again.png}  %inverted ion velocity as a correction, to look like Lefleur... :/
    \caption{Temporal evolution of the growth rate $\gamma$, the azimuthal wavenumber $k$ and the frequency $\omega$ for the most growing wave, obtained with several hypothesis on the dispersion relation. See text for more precisions. }
    \label{fig-time_wave}
  \end{figure}
  
  Three different behaviour are observed.
  First, the solution of the dispersion relation with Maxwellian electrons and cold ions (dashed green line in \cref{fig-time_wave}) presents a solution of $\omega$ and $k$ constant in time, and very close to the analytical values, beeing $k \lde = 1/\sqrt{2}$ and $\omega = \opi/\sqrt{3}$.
  However, it also presents a constant growth rate.
  
  Secondly, we observe that the solutions given with Maxwellian ions of temperature not zero are relatively similar for both the Maxwellian electrons  (dotted red line) and using the electron velocity distribution function measured in the \ac{PIC} simulation (dash-dotted orange line).
  In these cases, the growth rate decreases regularly to zero.
  
  Interestingly, the periods during which the growth rate is zero (firstly between $t=1\,\micro\second$ and $t=2\,\micro\second$, then around $t=3\,\micro\second$ and so on) correspond precisely to the periods during which the wave energy density decreases in \vref{fig-tempITcrit}.
  This means that the decrease of the wave amplitude would only be due to the ion temperature, and not its distribution function.
  However, we note that the value of the ion temperature $\Ti$ is highly affected by the population of ions trapped, as seen in \cref{subsec-VDFpic}.
  Hence, the effect of the trapped particle is indeed present, but only via its impact on the temperature.
  
  \vspace{1em}
  To finish with, we solved the \ac{IAW} dispersion relation without any hypothesis on the velocity distribution functions, by using the one measured in the PIC simulations (blue solid line in  \cref{fig-time_wave}).
  In this case, the beginning ($t < 1 \,\micro\second$) is quite similar to the other results.
  However, after that ($t > 1 \,\micro\second$) the growth rate never rises above zero, expect very slightly around $t=4\,\micro\second$.
  
  This result is non consistent with the observations of \cref{sec-PIC-ECDI}, where we saw that the instability amplitude is modulated over the whole simulation time.
  It is also in contrast with \citet{lafleur2018}, where the authors obtained a non-zero growth rate in an axial- azimuthal geometry.
  
  Up to now, there is non apparent explanation to the behaviour observed.
  It could be due to an error in the numerical algorithm, possible on both on the theory and in the implementation.
  Concerning the theory, we have seen in \cref{sec-DR-solver} that the numerical algorithm to compute the plasma dispersion function $\tilde{Z}$ proposed by \citet{xiehua-sheng2013} cannot give a good result for certain argument complex values.
  In addition, the truncation of the number of Fourier bases at $N=64$, which works well with a Maxwellian distribution, could generate a significant error when using distribution function far from a Maxwellian.
  In our specific case, the ion population is composed of a majority of cold Maxwellian ions and a small number of high energetic trapped ions.
  It is possible that this kind of distribution function is not well taken into account by the algorithm.
  
  Concerning the implementation, we tried to test and validate the codes, but the presence of an error is always possible.
  A common practice to validate a simulation code when no theoretical solution can be used to compare to is to use a Benchmark \citep{turner2013}.
  As a dispersion relation solver for general distributions would benefit the whole plasma physics community, developing such a benchmark that would compare the solution of independent implementations of the same algorithm, or different algorithm, seems very interesting.
  
  \inlinenote{add a small summary here ?}